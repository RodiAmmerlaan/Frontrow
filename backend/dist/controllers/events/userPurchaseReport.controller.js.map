{"version":3,"file":"userPurchaseReport.controller.js","sourceRoot":"","sources":["../../../src/controllers/events/userPurchaseReport.controller.ts"],"names":[],"mappings":";;;;;;AACA,oEAAgE;AAChE,sDAAmD;AACnD,gEAAwC;AACxC,yCAAmF;AAEnF,MAAa,4BAA6B,SAAQ,+BAAc;IAC5D;;;;;;OAMG;IAEH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;OA0HG;IACI,KAAK,CAAC,qBAAqB,CAC9B,OAAgB,EAChB,QAAkB;QAElB,MAAM,aAAa,GAAI,OAAe,CAAC,aAAa,IAAI,KAAK,CAAC;QAC9D,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,GAAG,OAAO,CAAC,KAAK,CAAC;QACtC,gBAAM,CAAC,KAAK,CAAC,IAAI,aAAa,8CAA8C,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QAE/F,IAAI,CAAC;YACD,MAAM,kBAAkB,GAAG,MAAM,gCAAc,CAAC,qBAAqB,CACjE,KAAK,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAe,CAAC,CAAC,CAAC,CAAC,SAAS,EAC7C,IAAI,CAAC,CAAC,CAAC,QAAQ,CAAC,IAAc,CAAC,CAAC,CAAC,CAAC,SAAS,CAC9C,CAAC;YAEF,gBAAM,CAAC,IAAI,CAAC,IAAI,aAAa,+CAA+C,CAAC,CAAC;YAC9E,OAAO,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE,kBAAkB,CAAC,CAAC;QAC1D,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACb,gBAAM,CAAC,KAAK,CAAC,IAAI,aAAa,6CAA6C,EAAE,KAAK,CAAC,CAAC;YACpF,IAAI,KAAK,YAAY,wBAAe,EAAE,CAAC;gBACnC,gBAAM,CAAC,IAAI,CAAC,IAAI,aAAa,yCAAyC,EAAE,EAAE,KAAK,EAAE,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;gBAClG,IAAI,CAAC,oBAAoB,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;YAC7C,CAAC;YACD,IAAI,KAAK,YAAY,sBAAa,EAAE,CAAC;gBACjC,gBAAM,CAAC,IAAI,CAAC,IAAI,aAAa,wCAAwC,EAAE,EAAE,KAAK,EAAE,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;gBACjG,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;YAC3C,CAAC;YACD,IAAI,CAAC,wBAAwB,CAAC,yCAAyC,CAAC,CAAC;QAC7E,CAAC;IACL,CAAC;CACJ;AAjKD,oEAiKC;AAEY,QAAA,4BAA4B,GAAG,IAAI,4BAA4B,EAAE,CAAC;AAClE,QAAA,qBAAqB,GAAG,oCAA4B,CAAC,qBAAqB,CAAC,IAAI,CAAC,oCAA4B,CAAC,CAAC","sourcesContent":["import { Request, Response } from 'express';\r\nimport { ReportsService } from '../../services/reports.service';\r\nimport { BaseController } from '../BaseController';\r\nimport Logger from '../../utils/logger';\r\nimport { ValidationError, NotFoundError, InternalServerError } from '../../errors';\r\n\r\nexport class UserPurchaseReportController extends BaseController {\r\n    /**\r\n     * Controller function to retrieve user purchase report data\r\n     * Calculates and returns user purchasing behavior metrics\r\n     * @param request - Express request object with optional month/year query parameters\r\n     * @param response - Express response object\r\n     * @returns Response with user purchase report data or error message\r\n     */\r\n    \r\n    /**\r\n     * @openapi\r\n     * /events/user-purchase-report:\r\n     *   get:\r\n     *     summary: Retrieve user purchase report data\r\n     *     description: Calculates and returns user purchasing behavior metrics, optionally filtered by month and year\r\n     *     tags:\r\n     *       - Events\r\n     *     security:\r\n     *       - bearerAuth: []\r\n     *     parameters:\r\n     *       - in: query\r\n     *         name: month\r\n     *         required: false\r\n     *         schema:\r\n     *           type: integer\r\n     *           minimum: 1\r\n     *           maximum: 12\r\n     *         description: Month to filter purchase data (1-12)\r\n     *       - in: query\r\n     *         name: year\r\n     *         required: false\r\n     *         schema:\r\n     *           type: integer\r\n     *           minimum: 2000\r\n     *           maximum: 2100\r\n     *         description: Year to filter purchase data (2000-2100)\r\n     *     responses:\r\n     *       200:\r\n     *         description: Successful response with user purchase report data\r\n     *         content:\r\n     *           application/json:\r\n     *             schema:\r\n     *               type: object\r\n     *               properties:\r\n     *                 success:\r\n     *                   type: boolean\r\n     *                 data:\r\n     *                   type: object\r\n     *                   properties:\r\n     *                     totalUsers:\r\n     *                       type: integer\r\n     *                     averageTicketsPerUser:\r\n     *                       type: number\r\n     *                     averageSpentPerUser:\r\n     *                       type: number\r\n     *                     mostActiveUser:\r\n     *                       type: object\r\n     *                       properties:\r\n     *                         id:\r\n     *                           type: string\r\n     *                         email:\r\n     *                           type: string\r\n     *                         ticketsPurchased:\r\n     *                           type: integer\r\n     *                         totalSpent:\r\n     *                           type: number\r\n     *       400:\r\n     *         description: Bad request - validation error\r\n     *         content:\r\n     *           application/json:\r\n     *             schema:\r\n     *               type: object\r\n     *               properties:\r\n     *                 success:\r\n     *                   type: boolean\r\n     *                 error:\r\n     *                   type: string\r\n     *                 message:\r\n     *                   type: string\r\n     *       401:\r\n     *         description: Unauthorized\r\n     *         content:\r\n     *           application/json:\r\n     *             schema:\r\n     *               type: object\r\n     *               properties:\r\n     *                 success:\r\n     *                   type: boolean\r\n     *                 error:\r\n     *                   type: string\r\n     *                 message:\r\n     *                   type: string\r\n     *       403:\r\n     *         description: Forbidden - admin access required\r\n     *         content:\r\n     *           application/json:\r\n     *             schema:\r\n     *               type: object\r\n     *               properties:\r\n     *                 success:\r\n     *                   type: boolean\r\n     *                 error:\r\n     *                   type: string\r\n     *                 message:\r\n     *                   type: string\r\n     *       404:\r\n     *         description: Purchase report data not found\r\n     *         content:\r\n     *           application/json:\r\n     *             schema:\r\n     *               type: object\r\n     *               properties:\r\n     *                 success:\r\n     *                   type: boolean\r\n     *                 error:\r\n     *                   type: string\r\n     *                 message:\r\n     *                   type: string\r\n     *       500:\r\n     *         description: Internal server error\r\n     *         content:\r\n     *           application/json:\r\n     *             schema:\r\n     *               type: object\r\n     *               properties:\r\n     *                 success:\r\n     *                   type: boolean\r\n     *                 error:\r\n     *                   type: string\r\n     *                 message:\r\n     *                   type: string\r\n     */\r\n    public async getUserPurchaseReport(\r\n        request: Request,\r\n        response: Response\r\n    ) {\r\n        const correlationId = (request as any).correlationId || 'N/A';\r\n        const { month, year } = request.query;\r\n        Logger.debug(`[${correlationId}] Get user purchase report controller called`, { month, year });\r\n        \r\n        try {\r\n            const userPurchaseReport = await ReportsService.getUserPurchaseReport(\r\n                month ? parseInt(month as string) : undefined,\r\n                year ? parseInt(year as string) : undefined\r\n            );\r\n            \r\n            Logger.info(`[${correlationId}] Successfully retrieved user purchase report`);\r\n            return this.sendSuccess(response, userPurchaseReport);\r\n        } catch (error) {\r\n            Logger.error(`[${correlationId}] Error in getUserPurchaseReportController:`, error);\r\n            if (error instanceof ValidationError) {\r\n                Logger.warn(`[${correlationId}] User purchase report validation error`, { error: error.message });\r\n                this.throwBadRequestError(error.message);\r\n            }\r\n            if (error instanceof NotFoundError) {\r\n                Logger.warn(`[${correlationId}] User purchase report not found error`, { error: error.message });\r\n                this.throwNotFoundError(error.message);\r\n            }\r\n            this.throwInternalServerError('Failed to retrieve user purchase report');\r\n        }\r\n    }\r\n}\r\n\r\nexport const userPurchaseReportController = new UserPurchaseReportController();\r\nexport const getUserPurchaseReport = userPurchaseReportController.getUserPurchaseReport.bind(userPurchaseReportController);"]}