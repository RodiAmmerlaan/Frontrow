{"version":3,"file":"OrderRepositoryImpl.js","sourceRoot":"","sources":["../../../src/repositories/OrderRepositoryImpl.ts"],"names":[],"mappings":"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","sourcesContent":["import { Orders } from \"@prisma/client\";\r\nimport { BaseRepositoryImpl } from \"./BaseRepositoryImpl\";\r\nimport { OrderRepository } from \"./OrderRepository\";\r\nimport { buildDateFilterWhereClause } from \"../utils/dateFilterUtils\";\r\nimport { RepositoryError, EntityNotFoundError } from '../errors/RepositoryError';\r\n\r\nexport class OrderRepositoryImpl extends BaseRepositoryImpl<Orders, string> implements OrderRepository {\r\n  /**\r\n   * Find an order by its ID\r\n   * @param id - The unique identifier of the order\r\n   * @returns A promise that resolves to the order or null if not found\r\n   */\r\n  async findById(id: string): Promise<Orders | null> {\r\n    return await this.prisma.orders.findUnique({ where: { id } });\r\n  }\r\n\r\n  /**\r\n   * Find all orders\r\n   * @returns A promise that resolves to an array of all orders\r\n   */\r\n  async findAll(): Promise<Orders[]> {\r\n    return await this.prisma.orders.findMany();\r\n  }\r\n\r\n  /**\r\n   * Create a new order\r\n   * @param orderData - The order data to create\r\n   * @returns A promise that resolves to the created order\r\n   */\r\n  async create(orderData: Omit<Orders, 'id' | 'created_at'>): Promise<Orders> {\r\n    return await this.prisma.orders.create({ data: orderData });\r\n  }\r\n\r\n  /**\r\n   * Update an existing order\r\n   * @param id - The unique identifier of the order to update\r\n   * @param orderData - The updated order data\r\n   * @returns A promise that resolves to the updated order or null if not found\r\n   */\r\n  async update(id: string, orderData: Partial<Orders>): Promise<Orders> {\r\n    try {\r\n      return await this.prisma.orders.update({\r\n        where: { id },\r\n        data: orderData\r\n      });\r\n    } catch (error: any) {\r\n      if (error.code === 'P2025') { \r\n        throw new EntityNotFoundError(`Order with ID ${id} not found`);\r\n      }\r\n      throw new RepositoryError(`Failed to update order with ID ${id}: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete an order by its ID\r\n   * @param id - The unique identifier of the order to delete\r\n   * @returns A promise that resolves to true if deletion was successful, false otherwise\r\n   */\r\n  async delete(id: string): Promise<boolean> {\r\n    try {\r\n      await this.prisma.orders.delete({ where: { id } });\r\n      return true;\r\n    } catch (error: any) {\r\n      if (error.code === 'P2025') {\r\n        throw new EntityNotFoundError(`Order with ID ${id} not found`);\r\n      }\r\n      throw new RepositoryError(`Failed to delete order with ID ${id}: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if an order exists by its ID\r\n   * @param id - The unique identifier to check\r\n   * @returns A promise that resolves to true if the order exists, false otherwise\r\n   */\r\n  async exists(id: string): Promise<boolean> {\r\n    const order = await this.prisma.orders.findUnique({ where: { id } });\r\n    return !!order;\r\n  }\r\n\r\n  /**\r\n   * Find orders by user ID\r\n   * @param userId - The ID of the user\r\n   * @returns A promise that resolves to an array of orders for the user\r\n   */\r\n  async findByUserId(userId: string): Promise<Orders[]> {\r\n    return await this.prisma.orders.findMany({ where: { user_id: userId } });\r\n  }\r\n\r\n  /**\r\n   * Find orders by event ID\r\n   * @param eventId - The ID of the event\r\n   * @returns A promise that resolves to an array of orders for the event\r\n   */\r\n  async findByEventId(eventId: string): Promise<Orders[]> {\r\n    const startDate = new Date(0);\r\n    return await this.prisma.orders.findMany({ \r\n      where: { \r\n        AND: [\r\n          { event_id: eventId },\r\n          { created_at: { gte: startDate } }\r\n        ]\r\n      } \r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get orders with related event and user information\r\n   * @returns A promise that resolves to an array of detailed order records\r\n   */\r\n  async findWithDetails(): Promise<Orders[]> {\r\n    return await this.prisma.orders.findMany({\r\n      include: {\r\n        Events: {\r\n          select: {\r\n            id: true,\r\n            title: true,\r\n            description: true,\r\n            start_time: true,\r\n            end_time: true\r\n          }\r\n        },\r\n        Users: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            first_name: true,\r\n            last_name: true\r\n          }\r\n        },\r\n        Tickets: true\r\n      },\r\n      orderBy: {\r\n        created_at: 'desc'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a new order for ticket purchase\r\n   * @param event_id - The ID of the event for which tickets are being purchased\r\n   * @param user_id - The ID of the user purchasing the tickets\r\n   * @param total_amount - The total number of tickets being purchased\r\n   * @returns A promise that resolves to the created order\r\n   */\r\n  async buyTickets(event_id: string, user_id: string, total_amount: number): Promise<Orders> {\r\n    return await this.create({\r\n        user_id: user_id,\r\n        event_id: event_id,\r\n        total_amount: total_amount\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Retrieves detailed sales data for events with related event and user information\r\n   * @param month - Optional month filter (1-12)\r\n   * @param year - Optional year filter\r\n   * @returns A promise that resolves to an array of detailed sales records\r\n   */\r\n  async getEventSalesDetails(month?: number, year?: number) {\r\n    const whereClause = buildDateFilterWhereClause({ month, year });\r\n    \r\n    return await this.prisma.orders.findMany({\r\n        where: whereClause,\r\n        include: {\r\n            Events: {\r\n                select: {\r\n                    id: true,\r\n                    title: true,\r\n                    description: true,\r\n                    start_time: true,\r\n                    end_time: true\r\n                }\r\n            },\r\n            Users: {\r\n                select: {\r\n                    id: true,\r\n                    email: true,\r\n                    first_name: true,\r\n                    last_name: true\r\n                }\r\n            },\r\n            Tickets: true\r\n        },\r\n        orderBy: {\r\n            created_at: 'desc'\r\n        }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Retrieves detailed user purchase data with related event and user information\r\n   * @param month - Optional month filter (1-12)\r\n   * @param year - Optional year filter\r\n   * @returns A promise that resolves to an array of detailed purchase records\r\n   */\r\n  async getUserPurchaseDetails(month?: number, year?: number) {\r\n    const whereClause = buildDateFilterWhereClause({ month, year });\r\n    \r\n    return await this.prisma.orders.findMany({\r\n        where: whereClause,\r\n        include: {\r\n            Events: {\r\n                select: {\r\n                    id: true,\r\n                    title: true,\r\n                    description: true,\r\n                    start_time: true,\r\n                    end_time: true,\r\n                    TicketBatches: {\r\n                        select: {\r\n                            price: true\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            Users: {\r\n                select: {\r\n                    id: true,\r\n                    email: true,\r\n                    first_name: true,\r\n                    last_name: true\r\n                }\r\n            },\r\n            Tickets: true\r\n        },\r\n        orderBy: {\r\n            created_at: 'desc'\r\n        }\r\n    });\r\n  }\r\n}"]}